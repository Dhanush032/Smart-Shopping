{% extends 'base.html' %}

{% block title %}Admin Dashboard - Smart Shopping Platform{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <h2 class="fw-bold mb-4">
                <i class="fas fa-tachometer-alt me-2"></i>Admin Dashboard
            </h2>
        </div>
    </div>
    

    <!-- Admin panel product details -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0" id="totalProductsAdmin">-</h4>
                            <p class="mb-0">Total Products</p>
                        </div>
                        <i class="fas fa-box fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0" id="totalOrdersAdmin">-</h4>
                            <p class="mb-0">Total Orders</p>
                        </div>
                        <i class="fas fa-shopping-bag fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0" id="pendingOrders">-</h4>
                            <p class="mb-0">Pending Orders</p>
                        </div>
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0" id="totalRevenue">-</h4>
                            <p class="mb-0">Total Revenue</p>
                        </div>
                        <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- admin access product -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-primary w-100" onclick="showAddProductModal()">
                                <i class="fas fa-plus me-2"></i>Add Product
                            </button>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-success w-100" onclick="showAddCategoryModal()">
                                <i class="fas fa-folder-plus me-2"></i>Add Category
                            </button>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="/admin/" class="btn btn-info w-100">
                                <i class="fas fa-cogs me-2"></i>Django Admin
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="/api/docs/" class="btn btn-secondary w-100">
                                <i class="fas fa-book me-2"></i>API Docs
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabs for different sections -->
    <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
                <i class="fas fa-shopping-bag me-2"></i>Recent Orders
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">
                <i class="fas fa-box me-2"></i>Products
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="lowstock-tab" data-bs-toggle="tab" data-bs-target="#lowstock" type="button" role="tab">
                <i class="fas fa-exclamation-triangle me-2"></i>Low Stock
            </button>
        </li>
    </ul>
    
    <div class="tab-content" id="adminTabsContent">
        <!-- Recent Orders -->
        <div class="tab-pane fade show active" id="orders" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Orders</h5>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadOrders()">
                        <i class="fas fa-refresh me-1"></i>Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="recentOrders">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">Loading orders...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Products  -->
        <div class="tab-pane fade" id="products" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Products Management</h5>
                    <div>
                        <input type="text" class="form-control d-inline-block w-auto me-2" id="productSearch" placeholder="Search products..." style="width: 200px !important;">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadProducts()">
                            <i class="fas fa-search me-1"></i>Search
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="productsTable">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">Loading products...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Low Stock  -->
        <div class="tab-pane fade" id="lowstock" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Low Stock Alert</h5>
                </div>
                <div class="card-body">
                    <div id="lowStockProducts">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">Loading low stock products...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Product  -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addProductForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="product_name" class="form-label">Product Name *</label>
                            <input type="text" class="form-control" id="product_name" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="product_category" class="form-label">Category *</label>
                            <select class="form-select" id="product_category" name="category_id" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="product_description" class="form-label">Description *</label>
                        <textarea class="form-control" id="product_description" name="description" rows="3" required></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="product_price" class="form-label">Price *</label>
                            <input type="number" class="form-control" id="product_price" name="price" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="product_discount_price" class="form-label">Discount Price</label>
                            <input type="number" class="form-control" id="product_discount_price" name="discount_price" step="0.01" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="product_stock" class="form-label">Stock Quantity *</label>
                            <input type="number" class="form-control" id="product_stock" name="stock_quantity" min="0" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="product_weight" class="form-label">Weight (kg)</label>
                            <input type="number" class="form-control" id="product_weight" name="weight" step="0.01" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="product_dimensions" class="form-label">Dimensions</label>
                            <input type="text" class="form-control" id="product_dimensions" name="dimensions" placeholder="L x W x H">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="product_featured" name="featured">
                                <label class="form-check-label" for="product_featured">Featured Product</label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="product_active" name="is_active" checked>
                                <label class="form-check-label" for="product_active">Active</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Category  -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addCategoryForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="category_name" class="form-label">Category Name *</label>
                        <input type="text" class="form-control" id="category_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="category_description" class="form-label">Description</label>
                        <textarea class="form-control" id="category_description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="category_active" name="is_active" checked>
                            <label class="form-check-label" for="category_active">Active</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Order Status Update -->
<div class="modal fade" id="updateOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Order Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="updateOrderForm">
                <div class="modal-body">
                    <input type="hidden" id="order_id">
                    <div class="mb-3">
                        <label for="order_status" class="form-label">Status *</label>
                        <select class="form-select" id="order_status" name="status" required>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="order_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="order_notes" name="order_notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Check admin access
    if (!currentUser || currentUser.role !== 'admin') {
        showAlert('Admin access required', 'danger');
        setTimeout(() => window.location.href = '/', 2000);
    }
    
    // show admin dashboard stats
    async function loadDashboardStats() {
        try {
            // show products count
            const productsResponse = await apiRequest('/api/products/');
            if (productsResponse && productsResponse.ok) {
                const productsData = await productsResponse.json();
                document.getElementById('totalProductsAdmin').textContent = productsData.count;
            }
            
            // show orders
            const ordersResponse = await apiRequest('/api/orders/orders/');
            if (ordersResponse && ordersResponse.ok) {
                const ordersData = await ordersResponse.json();
                const orders = ordersData.results || [];
                
                document.getElementById('totalOrdersAdmin').textContent = ordersData.count;
                
                // Calculate pending orders
                const pendingCount = orders.filter(order => order.status === 'pending').length;
                document.getElementById('pendingOrders').textContent = pendingCount;
                
                // Calculate total revenue
                const totalRevenue = orders.reduce((sum, order) => sum + parseFloat(order.total_amount), 0);
                document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            }
            
        } catch (error) {
            console.error('Error loading dashboard stats:', error);
        }
    }
    
    // show recent orders
    async function loadOrders() {
        try {
            const response = await apiRequest('/api/orders/orders/');
            if (response && response.ok) {
                const data = await response.json();
                displayRecentOrders(data.results.slice(0, 10)); 
            }
        } catch (error) {
            console.error('Error loading orders:', error);
            document.getElementById('recentOrders').innerHTML = '<p class="text-danger">Error loading orders</p>';
        }
    }
    
    // Display recent orders
    function displayRecentOrders(orders) {
        const container = document.getElementById('recentOrders');
        
        if (orders.length === 0) {
            container.innerHTML = '<p class="text-muted">No orders found</p>';
            return;
        }
        
        container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Order #</th>
                            <th>Customer</th>
                            <th>Status</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orders.map(order => `
                            <tr>
                                <td class="fw-bold">${order.order_number}</td>
                                <td>${order.user}</td>
                                <td><span class="status-badge status-${order.status}">${order.status.toUpperCase()}</span></td>
                                <td>$${order.total_amount}</td>
                                <td>${new Date(order.created_at).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn btn-outline-primary btn-sm me-1" onclick="showOrderDetails('${order.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" onclick="showUpdateOrderModal('${order.id}', '${order.status}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
    
    // Load products
    async function loadProducts() {
        const searchTerm = document.getElementById('productSearch').value;
        const params = new URLSearchParams();
        if (searchTerm) params.append('search', searchTerm);
        
        try {
            const response = await apiRequest(`/api/products/?${params}`);
            if (response && response.ok) {
                const data = await response.json();
                displayProducts(data.results || []);
            }
        } catch (error) {
            console.error('Error loading products:', error);
            document.getElementById('productsTable').innerHTML = '<p class="text-danger">Error loading products</p>';
        }
    }
    
    // Display products
    function displayProducts(products) {
        const container = document.getElementById('productsTable');
        
        if (products.length === 0) {
            container.innerHTML = '<p class="text-muted">No products found</p>';
            return;
        }
        
        container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${products.map(product => `
                            <tr>
                                <td>
                                    <img src="${product.image || 'https://images.pexels.com/photos/4041392/pexels-photo-4041392.jpeg?auto=compress&cs=tinysrgb&w=100'}" 
                                    class="rounded" style="width: 50px; height: 50px; object-fit: cover;" alt="${product.name}">
                                </td>
                                <td>
                                    <div class="fw-bold">${product.name}</div>
                                    ${product.featured ? '<span class="badge bg-primary">Featured</span>' : ''}
                                </td>
                                <td>${product.category.name}</td>
                                <td>
                                    ${product.discount_price ? 
                                        `<span class="text-primary fw-bold">$${product.discount_price}</span><br>
                                        <small class="text-muted text-decoration-line-through">$${product.price}</small>`
                                        : `$${product.price}`
                                    }
                                </td>
                                <td>
                                    <span class="badge ${product.stock_quantity > 10 ? 'bg-success' : product.stock_quantity > 0 ? 'bg-warning' : 'bg-danger'}">
                                        ${product.stock_quantity}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge ${product.is_active ? 'bg-success' : 'bg-secondary'}">
                                        ${product.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-outline-info btn-sm me-1" onclick="viewProduct('${product.slug}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" onclick="editProduct('${product.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
    
    // show low stock products
    async function loadLowStockProducts() {
        try {
            const response = await apiRequest('/api/products/low_stock/?threshold=10');
            if (response && response.ok) {
                const data = await response.json();
                displayLowStockProducts(data.results || []);
            }
        } catch (error) {
            console.error('Error loading low stock products:', error);
            document.getElementById('lowStockProducts').innerHTML = '<p class="text-danger">Error loading low stock products</p>';
        }
    }
    
    // show low stock products
    function displayLowStockProducts(products) {
        const container = document.getElementById('lowStockProducts');
        
        if (products.length === 0) {
            container.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>All products are well stocked!
                </div>
            `;
            return;
        }
        
        container.innerHTML = products.map(product => `
            <div class="alert alert-warning d-flex align-items-center">
                <img src="${product.image || 'https://images.pexels.com/photos/4041392/pexels-photo-4041392.jpeg?auto=compress&cs=tinysrgb&w=100'}" 
                class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;" alt="${product.name}">
                <div class="flex-grow-1">
                    <strong>${product.name}</strong><br>
                    <small>Category: ${product.category.name}</small><br>
                    <small>Stock: <span class="badge bg-warning">${product.stock_quantity} remaining</span></small>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="editProduct('${product.id}')">
                    Update Stock
                </button>
            </div>
        `).join('');
    }
    
    // show categories for product form
    async function loadCategories() {
        try {
            const response = await apiRequest('/api/products/categories/');
            if (response && response.ok) {
                const data = await response.json();
                const select = document.getElementById('product_category');
                select.innerHTML = '<option value="">Select Category</option>';
                data.results.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }
    
    // Show modals
    function showAddProductModal() {
        loadCategories();
        new bootstrap.Modal(document.getElementById('addProductModal')).show();
    }
    
    function showAddCategoryModal() {
        new bootstrap.Modal(document.getElementById('addCategoryModal')).show();
    }
    
    function showUpdateOrderModal(orderId, currentStatus) {
        document.getElementById('order_id').value = orderId;
        document.getElementById('order_status').value = currentStatus;
        new bootstrap.Modal(document.getElementById('updateOrderModal')).show();
    }
    
    // Form submissions
    document.getElementById('addProductForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {
            name: formData.get('name'),
            description: formData.get('description'),
            price: parseFloat(formData.get('price')),
            discount_price: formData.get('discount_price') ? parseFloat(formData.get('discount_price')) : null,
            stock_quantity: parseInt(formData.get('stock_quantity')),
            category_id: parseInt(formData.get('category_id')),
            weight: formData.get('weight') ? parseFloat(formData.get('weight')) : null,
            dimensions: formData.get('dimensions') || '',
            featured: formData.has('featured'),
            is_active: formData.has('is_active')
        };
        
        try {
            const response = await apiRequest('/api/products/', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            if (response && response.ok) {
                showAlert('Product added successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
                loadProducts();
                loadDashboardStats();
                this.reset();
            } else {
                const error = await response.json();
                showAlert('Failed to add product: ' + JSON.stringify(error), 'danger');
            }
        } catch (error) {
            console.error('Error adding product:', error);
            showAlert('Error adding product', 'danger');
        }
    });
    
    document.getElementById('addCategoryForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {
            name: formData.get('name'),
            description: formData.get('description') || '',
            is_active: formData.has('is_active')
        };
        
        try {
            const response = await apiRequest('/api/products/categories/', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            if (response && response.ok) {
                showAlert('Category added successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
                this.reset();
            } else {
                const error = await response.json();
                showAlert('Failed to add category: ' + JSON.stringify(error), 'danger');
            }
        } catch (error) {
            console.error('Error adding category:', error);
            showAlert('Error adding category', 'danger');
        }
    });
    
    document.getElementById('updateOrderForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const orderId = document.getElementById('order_id').value;
        const formData = new FormData(this);
        const data = {
            status: formData.get('status'),
            order_notes: formData.get('order_notes') || ''
        };
        
        try {
            const response = await apiRequest(`/api/orders/orders/${orderId}/update_status/`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });
            
            if (response && response.ok) {
                showAlert('Order status updated successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('updateOrderModal')).hide();
                loadOrders();
                this.reset();
            } else {
                const error = await response.json();
                showAlert('Failed to update order: ' + JSON.stringify(error), 'danger');
            }
        } catch (error) {
            console.error('Error updating order:', error);
            showAlert('Error updating order', 'danger');
        }
    });
    
    // Tab change events
    document.getElementById('products-tab').addEventListener('shown.bs.tab', loadProducts);
    document.getElementById('lowstock-tab').addEventListener('shown.bs.tab', loadLowStockProducts);
    
    // Search on enter key
    document.getElementById('productSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            loadProducts();
        }
    });
    
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        if (currentUser && currentUser.role === 'admin') {
            loadDashboardStats();
            loadOrders();
        }
    });
</script>
{% endblock %}