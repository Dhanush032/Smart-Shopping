{% extends 'base.html' %}

{% block title %}Shopping Cart - Smart Shopping Platform{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <h2 class="fw-bold mb-4">
                <i class="fas fa-shopping-cart me-2"></i>Shopping Cart
            </h2>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <!-- use for Cart items -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Cart Items</h5>
                </div>
                <div class="card-body" id="cartItems">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading cart...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Cart Summary -->
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header">
                    <h5 class="mb-0">Order Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Items:</span>
                        <span id="totalItems">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Subtotal:</span>
                        <span class="fw-bold" id="subtotal">$0.00</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <strong>Total:</strong>
                        <strong class="text-primary" id="total">$0.00</strong>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg" id="checkoutBtn" onclick="proceedToCheckout()" disabled>
                            <i class="fas fa-credit-card me-2"></i>Proceed to Checkout
                        </button>
                        <a href="/products/" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Continue Shopping
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Checkout  -->
<div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Checkout</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="checkoutForm">
                <div class="modal-body">
                    <h6 class="mb-3">Shipping Information</h6>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="shipping_address" class="form-label">Address *</label>
                            <textarea class="form-control" id="shipping_address" name="shipping_address" rows="3" required></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="shipping_city" class="form-label">City *</label>
                            <input type="text" class="form-control" id="shipping_city" name="shipping_city" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="shipping_state" class="form-label">State *</label>
                            <input type="text" class="form-control" id="shipping_state" name="shipping_state" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="shipping_zip_code" class="form-label">ZIP Code *</label>
                            <input type="text" class="form-control" id="shipping_zip_code" name="shipping_zip_code" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="shipping_phone" class="form-label">Phone *</label>
                            <input type="tel" class="form-control" id="shipping_phone" name="shipping_phone" required>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="order_notes" class="form-label">Order Notes (Optional)</label>
                            <textarea class="form-control" id="order_notes" name="order_notes" rows="2" placeholder="Any special instructions..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="placeOrderBtn">
                        <i class="fas fa-check me-2"></i>Place Order
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let cart = null;
    
    // show cart
    async function loadCart() {
        if (!currentUser) {
            document.getElementById('cartItems').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-sign-in-alt fa-3x text-muted mb-3"></i>
                    <h5>Please login to view your cart</h5>
                    <a href="/login/" class="btn btn-primary">Login</a>
                </div>
            `;
            return;
        }
        
        try {
            const response = await apiRequest('/api/orders/cart/1/');
            if (response && response.ok) {
                cart = await response.json();
                displayCart();
                updateSummary();
            } else {
                throw new Error('Failed to load cart');
            }
        } catch (error) {
            console.error('Error loading cart:', error);
            document.getElementById('cartItems').innerHTML = `
                <div class="text-center py-5">
                    <p class="text-danger">Error loading cart</p>
                    <button class="btn btn-outline-primary" onclick="loadCart()">Retry</button>
                </div>
            `;
        }
    }
    
    // Display cart items
    function displayCart() {
        const container = document.getElementById('cartItems');
        
        if (!cart || !cart.items || cart.items.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                    <h5>Your cart is empty</h5>
                    <p class="text-muted">Start shopping to add items to your cart</p>
                    <a href="/products/" class="btn btn-primary">Shop Now</a>
                </div>
            `;
            return;
        }
        
        container.innerHTML = cart.items.map(item => `
            <div class="border-bottom pb-3 mb-3" id="item-${item.id}">
                <div class="row align-items-center">
                    <div class="col-md-2">
                        <img src="${item.product.image || 'https://images.pexels.com/photos/4041392/pexels-photo-4041392.jpeg?auto=compress&cs=tinysrgb&w=200'}" 
                        class="img-fluid rounded" alt="${item.product.name}">
                    </div>
                    <div class="col-md-4">
                        <h6 class="mb-1">${item.product.name}</h6>
                        <small class="text-muted">${item.product.category.name}</small>
                        <div class="mt-2">
                            ${item.product.discount_price ? 
                                `<span class="text-primary fw-bold">$${item.product.discount_price}</span>
                                <small class="text-muted text-decoration-line-through ms-2">$${item.product.price}</small>`
                                : `<span class="text-primary fw-bold">$${item.product.price}</span>`
                            }
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(${item.id}, ${item.quantity - 1})">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" class="form-control text-center" value="${item.quantity}" 
                            min="1" max="${item.product.stock_quantity}" onchange="updateQuantity(${item.id}, this.value)">
                            <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(${item.id}, ${item.quantity + 1})"
                                    ${item.quantity >= item.product.stock_quantity ? 'disabled' : ''}>
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <small class="text-muted">Stock: ${item.product.stock_quantity}</small>
                    </div>
                    <div class="col-md-2">
                        <div class="text-end">
                            <div class="fw-bold text-primary">$${item.subtotal}</div>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-outline-danger btn-sm" onclick="removeItem(${item.id})" title="Remove item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
        // Add clear cart button
        if (cart.items.length > 0) {
            container.innerHTML += `
                <div class="text-end">
                    <button class="btn btn-outline-danger" onclick="clearCart()">
                        <i class="fas fa-trash-alt me-2"></i>Clear Cart
                    </button>
                </div>
            `;
        }
    }
    
    // Update cart summary
    function updateSummary() {
        if (!cart) return;
        
        document.getElementById('totalItems').textContent = cart.total_items;
        document.getElementById('subtotal').textContent = `$${cart.total_price}`;
        document.getElementById('total').textContent = `$${cart.total_price}`;
        
        const checkoutBtn = document.getElementById('checkoutBtn');
        checkoutBtn.disabled = !cart.items || cart.items.length === 0;
        
        updateCartCount();
    }
    
    // Update item quantity
    async function updateQuantity(itemId, newQuantity) {
        if (newQuantity < 1) {
            removeItem(itemId);
            return;
        }
        
        try {
            const response = await apiRequest('/api/orders/cart/update_item/', {
                method: 'PUT',
                body: JSON.stringify({
                    item_id: itemId,
                    quantity: parseInt(newQuantity)
                })
            });
            
            if (response && response.ok) {
                loadCart(); 
            } else {
                const error = await response.json();
                showAlert(error.error || 'Failed to update quantity', 'danger');
            }
        } catch (error) {
            console.error('Error updating quantity:', error);
            showAlert('Error updating quantity', 'danger');
        }
    }
    
    // Remove item from cart
    async function removeItem(itemId) {
        if (!confirm('Are you sure you want to remove this item from your cart?')) {
            return;
        }
        
        try {
            const response = await apiRequest('/api/orders/cart/remove_item/', {
                method: 'DELETE',
                body: JSON.stringify({
                    item_id: itemId
                })
            });
            
            if (response && response.ok) {
                showAlert('Item removed from cart', 'success');
                loadCart();
            } else {
                showAlert('Failed to remove item', 'danger');
            }
        } catch (error) {
            console.error('Error removing item:', error);
            showAlert('Error removing item', 'danger');
        }
    }
    
    // Clear entire cart
    async function clearCart() {
        if (!confirm('Are you sure you want to clear your entire cart?')) {
            return;
        }
        
        try {
            const response = await apiRequest('/api/orders/cart/clear/', {
                method: 'DELETE'
            });
            
            if (response && response.ok) {
                showAlert('Cart cleared', 'success');
                loadCart();
            } else {
                showAlert('Failed to clear cart', 'danger');
            }
        } catch (error) {
            console.error('Error clearing cart:', error);
            showAlert('Error clearing cart', 'danger');
        }
    }
    
    // Proceed to checkout
    function proceedToCheckout() {
        if (!cart || !cart.items || cart.items.length === 0) {
            showAlert('Your cart is empty', 'warning');
            return;
        }
        
        
        if (currentUser.address) {
            document.getElementById('shipping_address').value = currentUser.address;
        }
        if (currentUser.phone_number) {
            document.getElementById('shipping_phone').value = currentUser.phone_number;
        }
        
        new bootstrap.Modal(document.getElementById('checkoutModal')).show();
    }
    
    // Handle checkout form submission
    document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const placeOrderBtn = document.getElementById('placeOrderBtn');
        const originalText = placeOrderBtn.innerHTML;
        
        placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Placing Order...';
        placeOrderBtn.disabled = true;
        
        const formData = new FormData(this);
        const data = {
            shipping_address: formData.get('shipping_address'),
            shipping_city: formData.get('shipping_city'),
            shipping_state: formData.get('shipping_state'),
            shipping_zip_code: formData.get('shipping_zip_code'),
            shipping_phone: formData.get('shipping_phone'),
            order_notes: formData.get('order_notes') || ''
        };
        
        try {
            const response = await apiRequest('/api/orders/orders/create_order/', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            if (response && response.ok) {
                const order = await response.json();
                showAlert('Order placed successfully!', 'success');
                
                // Hide modal and redirect to orders page
                bootstrap.Modal.getInstance(document.getElementById('checkoutModal')).hide();
                
                setTimeout(() => {
                    window.location.href = '/orders/';
                }, 2000);
            } else {
                const error = await response.json();
                showAlert(error.error || 'Failed to place order', 'danger');
            }
        } catch (error) {
            console.error('Error placing order:', error);
            showAlert('Error placing order', 'danger');
        } finally {
            placeOrderBtn.innerHTML = originalText;
            placeOrderBtn.disabled = false;
        }
    });
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        if (!currentUser) {
            document.getElementById('cartItems').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-sign-in-alt fa-3x text-muted mb-3"></i>
                    <h5>Please login to view your cart</h5>
                    <a href="/login/" class="btn btn-primary">Login</a>
                </div>
            `;
        } else {
            loadCart();
        }
    });
</script>
{% endblock %}